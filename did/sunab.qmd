---
title: "Sun and Abraham (2021) Estimator"
---

```{r}
#| message: false
#| warning: false

# Packages Needed:
library(fixest)
```

There are two [issues with the two-way fixed effects estimator](staggered.qmd): forbidden comparisons and issues with weighting. Sun and Abraham (2021) proposes a new estimator to solve this issues.

The estimator divides all units into groups based on their initial treatment implementation. These groups are encoded into a new categorical variable $G_i$. Then, the estimator calculates dynamic ATT's separately for group, using only valid comparisons. This is done by interacting a relative-time variable $\widetilde T_{it}$ with $G_i$.

This model will produce many coefficients $\blue{\tau_{it}}$ (in fact, one for each post-treatment time period for each initial treatment year group). These are manually aggregated together into dynamic ATT's by relative treatment time using proper weighting. This solves the weighting problem with TWFE.

```{r}
#| echo: false
#| warning: false
#| message: false

data(base_stagg, package = "fixest")
df <- base_stagg
colnames(df) <- c("unit", "time", "first.treated", "rel.time", "treat", "te", "covariate", "outcome")
```

```{r}
#| warning: false
#| message: false

model <- feols(
  outcome ~ sunab(first.treated, time, att = T) + covariate | unit + time,
      #first.treated for never-treated should be some value outside of time-range
      #first.treated should not be NA.
  data = df,
  vcov = ~unit)

tail(model$coeftable) # the ATT is listed at the end of the coef table
```

::: small
The ATT is given by the estimate of the ATT in the table. Here, we can see the ATT is -1.1337.
:::

We can also calculate dynamic treatment effects and plot them:

```{r}
#| warning: false
#| message: false
#| fig-height: 3.5

model <- feols(
  outcome ~ sunab(first.treated, time) + covariate | unit + time,
      #att = T makes it calculate a singular ATT
  data = df,
  vcov = ~unit)

iplot(
  model,
  drop = "[[:digit:]]{2}",
      # this drops the time periods too far before and after treatment.
  ref.line = 0)
```

::: small
For technical details, see [Sun and Abraham (2021)](https://www.sciencedirect.com/science/article/abs/pii/S030440762030378X) or [this github page](https://asjadnaqvi.github.io/DiD/docs/code_r/07_sunab_r/).
:::
