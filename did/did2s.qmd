---
title: "Gardner (2021) Two-Stage Difference-in-Differences"
---

::: small
See [Kyle Butts'](https://kylebutts.github.io/did2s/articles/Two-Stage-Difference-in-Differences.html) github page for more info on this estimator. [Asjad Naqvi](https://asjadnaqvi.github.io/DiD/docs/code_r/07_did2s_r/) also has a helpful page.
:::

Gardner (2021) proposes to solve the [issues with two-way fixed effects](twfestaggered.qmd) regarding "forbidden comparisons" and "weighting" problems by just not doing comparisons and weighting.

Instead, Gardner (2021) proposes to calculate the treatment effects directly, as discussed in the introduction to [difference-in-differences](did.qmd):

$$
\tau_\text{ATT} = \pT - \pCred
$$

However, the hypothetical control outcome (in red) for treated units in the post-period are unobserved. Thus, the goal of 2-stage difference-in-differences is to estimate $\pCred$.

By definition, $\pCred$ is the hypothetical world if treatment never occurred. Thus, using the idea of two-way fixed effects, we should be able to calculate $\pCred$ if we simply set treatment = 0 in the TWFE equation:

$$
\pCred = \unit + \time + \beta \ \cov + \eps
$$

::: small
This equation is obtained by taking the [two-way fixed effects](twfe.qmd) equation and plugging in treatment = 0.
:::

Gardner's 2-stage difference-in-differences uses this equation and framework above, and attempts to estimate $\pCred$.

1.  First, Gardner uses only control units (treatment = 0) in a regression to estimate $\time$, $\unit$, and $\beta$. The choice of using only control units is to ensure that the estimation of hypothetical controls is accurate and not influenced by the treatment.
2.  Then, using the estimated $\widehat\time$, $\widehat\unit$, and $\widehat\beta$, we can estimate $\pCred$ using the equation above. This will give us an estimate of the hypothetical outcome.
3.  Once we have estimated $\pCred$, we can calculate the treatment effects for the treated units, as we have an estimate for the hypothetical outcomes.
4.  Then, we average all the individual treatment effects to get the ATT.

<br />

To implement 2-stage difference-in-differences, we need the **did2s** package:

```{r, eval = F}
library(did2s)
```

For the estimation of the ATT, we do the following:

```{r, eval = F}
model <- did2s(data = my_data,
               yname = "outcome",
               first_stage = ~ covariate1 + covariate2 | unit + time,
               second_stage = ~i(treatment),
               treatment = "treatment",
               cluster_var = "unit")
model
```

::: small
If you have no covariates, replace the covariates with 0 (so it looks something like " \~ 0 \| unit + time")
:::

For estimation of dynamic treatment effects (and testing of parallel trends), we do the following:

```{r, eval = F}
model <- did2s(data = my_data,
               yname = "outcome",
               first_stage = ~ covariate1 + covariate2 | unit + time,
               second_stage = ~i(rel_time, ref = c(-1, Inf)),
               treatment = "treatment",
               cluster_var = "unit")
model
iplot(model) #to view dynamic treatment effects plot
```

::: small
If you have no covariates, replace the covariates with 0 (so it looks something like " \~ 0 \| unit + time")

Note: the **inf** is the reference for the never-treated control group, for the variable time_to_treat. If it is NA's, then you do not need to include it, just put ref = -1.
:::
