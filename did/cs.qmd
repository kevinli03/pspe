---
title: "Callaway and Sant'Anna Flexible Matching and Reweighting Estimator"
---

```{r}
#| message: false
#| warning: false

# Packages Needed
library(did)
```

Callaway and Sant'Anna (2021) proposes to solve the [issues with two-way fixed effects](staggered.qmd) by carefully selecting the comparisons, and properly weighting the comparisons:

We first divide all units $i$ into groups, based on their first initial year of receiving treatment. Each unit who was first treated in year $g$ is assigned to group $g$.

Then, we define a new causal estimand of interest: what they call the group-time ATT. This is essentially the dynamic treatment effect of group $g$ at time $t$. We estimate the group-time ATT.

```{r}
#| echo: false
#| message: false
#| warning: false

data(base_stagg, package = "fixest")
df <- base_stagg
colnames(df) <- c("unit", "time", "first.treated", "rel.time", "treat", "te", "covariate", "outcome")
```

```{r}
#| message: false
#| warning: false

set.seed(344) # for replication
model <- att_gt(
  yname = "outcome", tname = "time", idname = "unit",
  gname = "first.treated",
  xformla = ~ covariate,
      # you can delete argument xformla if no covariates
  control_group = c("nevertreated"), # don't change
  est_method = 'dr', base_period = 'universal', #don't change
  allow_unbalanced_panel = T, #don't change
  data = df)
```

Now, we can weight each group-time ATT together based on how frequent each group $g$ is. By properly weighting, we solve the weighting issue of TWFE:

```{r}
#| message: false
#| warning: false

att <- did::aggte(
  model,
  type = "simple",
  na.rm = TRUE)
summary(att)
```

::: small
We can see the ATT estimate is -1.1237.
:::

We can also see ATT's weighted to show dynamic treatment effects:

```{r}
#| warning: false
#| message: false
#| fig-height: 3.5

att_dynamic <- did::aggte(
  model,
  type = "dynamic",
  na.rm = TRUE)
ggdid(att_dynamic)
```
