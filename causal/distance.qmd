---
title: "Distance Matching"
---

```{r}
#| message: false
#| warning: false

# Packages Needed:
library(Matching)
```

Mia is in our study and receives the treatment. Mia's causal effect is:

$$
\tau_{\text{Mia}} = \textcolor{green}{Y^{(1)}_\text{Mia}} - \textcolor{red}{Y^{(0)}_\text{Mia}}
$$

We cannot observe Mia's counterfactual (in red), since Mia receives the treatment.. However, what we can do is to find an untreated individual similar to Mia to approximate Mia's counterfactual:

$$
\tau_{\text{Mia}} \approx \textcolor{green}{Y^{(1)}_\text{Mia}} - \textcolor{red}{Y^{(0)}_\text{Matched Individual}}
$$

Distance matching matches an individual that is treated (like Mia) with one that is not treated based on how **close** their confounding values are. We define closeness by Mahalanobis distance:

$$
\text{distance}_{i, j} = \sqrt{(\b x_i - \b x_j)' \ \b\Sigma_x^{-1} (\b x_i - \b x_j)}
$$

::: small
Where $i$ and $j$ are two units we want to measure the distance between, $\b x$ is a vector of confounder values, and $\b\Sigma_x$ is the covariance matrix of confounders.
:::

```{r}
#| echo: false
#| message: false
#| warning: false


library(tidyverse)
N = 1000
ATE = 2
  
df = tibble(
  cov1 = rbinom(N, 1, 0.5),
  cov2 = rnorm(N),
  P = rnorm(N),
  U = rnorm(N), 
  W = rnorm(N),
) %>%
  mutate(
    Y0 = 1 + 0.5*cov1 + 0.5*cov2 + 0.5*P + 0.5*U,
    Y1 = Y0 + rnorm(N, mean = ATE*1.5, sd = 1)*cov1 + rnorm(N, mean = ATE/2)*(1-cov1)
  )

df = df %>%
  mutate(
    U2 = rnorm(N),
    pscore = 1/(1 + exp(-(-1 - 2*cov1 - 1.5*cov2 + 1.5*W + 0.5*U2))),
    treatment = rbinom(N, 1, pscore),
    outcome = Y1*treatment + Y0*(1-treatment)
  )
```

```{r}
#| warning: false
#| message: false
#| comment: "#>"
#| class-output: r

model <- Match(
  Y = df$outcome,
  Tr = df$treatment,
  X = df[,c("cov1","cov2")],
  M = 1,
      # number of matches - default is 1 to 1, but we can match more to 1
  BiasAdjust = TRUE,
      # modern adjustment - usually good to keep on
  Weight = 2)
summary(model)
```

Our output estimate will be the ATT - the average treatment effect for those units who received the treatment.

+----------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------+
| Pros                                                                                                                                         | Cons                                                    |
+==============================================================================================================================================+=========================================================+
| 1\) Non-parametric, so it does not need to assume a linear relationship between confounders and outcome like the fully interacted estimator. | 1\) Can be badly biased when more than 3-5 confounders. |
|                                                                                                                                              |                                                         |
| 2\) Very intuitive idea of matching similar individuals.                                                                                     | 2\) Throws out unmatched data, so it wastes data.       |
|                                                                                                                                              |                                                         |
|                                                                                                                                              | 3\) Does not estimate the ATE, only the ATT.            |
+----------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------+

: {tbl-colwidths="\[50,50\]"}

::: small
Kevin's comments: there is little reason to use distance matching over [genetic matching](genetic.qmd), unless your machine lacks the computational power for genetic matching.
:::
